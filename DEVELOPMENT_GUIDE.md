# AudioSpectrumVisualizer - 开发文档

## 📚 目录

1. [项目概述](#项目概述)
2. [快速开始](#快速开始)
3. [验证频谱图正确性](#验证频谱图正确性)
4. [开发历史](#开发历史)

---

## 项目概述

**AudioSpectrumVisualizer** 是一个专业的音频可视化控件库，包含：

- **SpectrumControl** - 频谱图控件（柱状图/曲线/填充曲线）
- **SpectrogramControl** - 声谱图控件（瀑布式热力图）
- **FFTProcessor** - FFT处理器（Cooley-Tukey算法）
- **ColorTheme** - 主题系统（深色/浅色主题）

### 核心特性

✅ **完全可配置** - 40+ 个公共属性
✅ **线程安全** - 支持多线程数据更新
✅ **高性能** - 双缓冲、unsafe代码优化
✅ **专业级功能** - 坐标轴、峰值检测、多种显示模式
✅ **响应式布局** - 使用 SplitContainer 实现动态高度对齐
✅ **主题系统** - 支持深色/浅色主题切换
✅ **设置持久化** - 窗口状态和配置自动保存
✅ **MIT许可证** - 完全开源，可商用

---

## 快速开始

### 构建项目

```bash
# 在 Visual Studio 中
1. 打开 SpectrumAnalysis.sln
2. 按 Ctrl+Shift+B 构建解决方案
3. 按 F5 运行程序

# 或使用 MSBuild
msbuild SpectrumAnalysis.sln /p:Configuration=Release
```

### 在其他项目中使用

```csharp
using AudioSpectrumVisualizer.Controls;
using AudioSpectrumVisualizer.DSP;

// 创建FFT处理器
var fftProcessor = new FFTProcessor(2048);

// 创建频谱图控件
var spectrum = new SpectrumControl
{
    SampleRate = 44100,
    BarColor = Color.Cyan,
    ShowAxis = true,
    ShowPeaks = true
};

// 创建声谱图控件
var spectrogram = new SpectrogramControl
{
    SampleRate = 44100,
    ShowAxis = true
};

// 处理音频数据
float[] audioData = GetAudioSamples();
float[] fftData = fftProcessor.ProcessFFT(audioData);

// 更新可视化
spectrum.UpdateSpectrum(fftData);
spectrogram.UpdateSpectrogram(fftData);
```

---

## 验证频谱图正确性

### 方法1：使用标准测试音频

#### 1.1 单频正弦波测试

**测试方法：**
1. 使用音频生成软件（如 Audacity）生成纯正弦波
2. 播放 440Hz 正弦波（标准 A4 音符）
3. 观察频谱图

**预期结果：**
- ✅ 在 440Hz 位置应该有一个明显的峰值
- ✅ 峰值检测应该标记为 "#1: 440.0 Hz"
- ✅ 其他频率的能量应该很低（接近底部）

**生成测试音频（Audacity）：**
```
1. 打开 Audacity
2. 生成 -> 音调 -> 正弦波
3. 频率: 440 Hz
4. 振幅: 0.8
5. 时长: 5 秒
6. 播放并观察频谱图
```

#### 1.2 多频测试

**测试方法：**
1. 生成包含多个频率的音频（例如：440Hz + 880Hz + 1320Hz）
2. 播放音频
3. 观察频谱图

**预期结果：**
- ✅ 应该看到 3 个明显的峰值
- ✅ 峰值位置分别在 440Hz、880Hz、1320Hz
- ✅ 峰值检测应该标记前 3 个峰值

#### 1.3 白噪声测试

**测试方法：**
1. 播放白噪声音频
2. 观察频谱图

**预期结果：**
- ✅ 所有频率的能量应该大致相等
- ✅ 频谱图应该显示为相对平坦的分布
- ✅ 没有明显的峰值

### 方法2：使用在线频率生成器

**推荐网站：**
- https://www.szynalski.com/tone-generator/
- https://onlinetonegenerator.com/

**测试步骤：**
1. 打开在线频率生成器
2. 设置频率（例如 1000Hz）
3. 播放音调
4. 在程序中点击"开始采集"
5. 观察频谱图

**验证要点：**
- ✅ 峰值位置应该在设置的频率附近（±20Hz 误差是正常的）
- ✅ 峰值应该是最高的（红色标记）
- ✅ 鼠标悬停在峰值上应该显示正确的频率

### 方法3：使用乐器或人声

#### 3.1 钢琴测试

**测试方法：**
1. 播放钢琴音符（例如中央 C = 261.63Hz）
2. 观察频谱图

**预期结果：**
- ✅ 基频峰值在 ~262Hz
- ✅ 谐波峰值在 ~524Hz、~786Hz、~1048Hz 等
- ✅ 峰值检测应该标记基频和主要谐波

#### 3.2 人声测试

**测试方法：**
1. 对着麦克风说话或唱歌
2. 观察频谱图

**预期结果：**
- ✅ 男声基频：100-150Hz
- ✅ 女声基频：200-300Hz
- ✅ 共振峰：500-4000Hz 范围内有多个峰值
- ✅ 声谱图应该显示清晰的时间变化

### 方法4：频率扫描测试

**测试方法：**
1. 使用频率扫描音频（20Hz → 20kHz）
2. 播放音频
3. 观察频谱图和声谱图

**预期结果：**
- ✅ 频谱图的峰值应该从左向右移动
- ✅ 声谱图应该显示从左到右的亮线（瀑布式）
- ✅ 峰值频率应该随时间线性增加

**生成扫描音频（Audacity）：**
```
1. 生成 -> 音调 -> 啁啾声
2. 起始频率: 20 Hz
3. 结束频率: 20000 Hz
4. 时长: 10 秒
5. 播放并观察
```

### 方法5：对比专业软件

**推荐对比软件：**
- **Audacity** - 免费，内置频谱分析
- **Sonic Visualiser** - 专业音频分析工具
- **Spek** - 轻量级频谱分析器

**对比步骤：**
1. 在专业软件中打开相同的音频文件
2. 查看其频谱图
3. 在本程序中播放相同音频
4. 对比峰值位置和频率分布

**验证要点：**
- ✅ 峰值位置应该一致（±20Hz）
- ✅ 相对幅度应该相似
- ✅ 频率分布应该相似

### 方法6：数学验证

#### 6.1 频率分辨率验证

**理论计算：**
```
应用程序配置:
  采样率: 48000 Hz
  FFT大小: 4096
  频率分辨率 = 48000 / 4096 ≈ 11.7 Hz

库默认配置:
  采样率: 44100 Hz
  FFT大小: 2048
  频率分辨率 = 44100 / 2048 ≈ 21.5 Hz
```

**验证方法：**
1. 播放两个相近的频率（例如 440Hz 和 460Hz）
2. 观察是否能分辨出两个峰值

**预期结果：**
- ✅ 应用程序（11.7 Hz 分辨率）：频率差 > 11.7Hz 应该能看到两个独立的峰值
- ✅ 库默认（21.5 Hz 分辨率）：频率差 > 21.5Hz 应该能看到两个独立的峰值
- ✅ 频率差小于分辨率：可能只看到一个宽峰值

#### 6.2 奈奎斯特频率验证

**理论：**
```
应用程序: 48000 Hz → 奈奎斯特频率 = 24000 Hz
库默认: 44100 Hz → 奈奎斯特频率 = 22050 Hz
```

**验证方法：**
1. 播放 20kHz 的音频
2. 观察频谱图

**预期结果：**
- ✅ 峰值应该在 ~20kHz 位置
- ✅ 应用程序：不应该有超过 24000Hz 的内容
- ✅ 库默认：不应该有超过 22050Hz 的内容

### 常见问题排查

#### 问题1：峰值位置不准确

**可能原因：**
- 采样率设置错误
- FFT窗函数问题
- 音频设备采样率不匹配

**解决方法：**
```csharp
// 确认采样率设置正确（应用程序使用 48000 Hz）
_spectrumControl.SampleRate = 48000;
_spectrogramControl.SampleRate = 48000;
_audioCapture = new AudioCapture(48000, 4096);

// 或使用库默认值（44100 Hz）
_spectrumControl.SampleRate = 44100;
_spectrogramControl.SampleRate = 44100;
_audioCapture = new AudioCapture(44100, 2048);
```

#### 问题2：频谱图显示异常

**可能原因：**
- 麦克风未正常工作
- 音量太低
- dB范围设置不当

**解决方法：**
```csharp
// 调整dB范围
_spectrumControl.MinDb = -80f;
_spectrumControl.MaxDb = 0f;

// 检查麦克风
// Windows设置 -> 声音 -> 输入 -> 测试麦克风
```

#### 问题3：峰值检测不准确

**可能原因：**
- 峰值最小间隔设置太小
- 噪声干扰

**解决方法：**
```csharp
// 调整峰值检测参数
_spectrumControl.PeakCount = 3;
_spectrumControl.PeakMinDistance = 100;  // 增加最小间隔
```

### 验证清单

使用以下清单验证频谱图功能：

- [ ] **单频测试**：440Hz 正弦波显示正确
- [ ] **多频测试**：多个峰值位置正确
- [ ] **白噪声测试**：频谱分布平坦
- [ ] **频率扫描**：峰值从左向右移动
- [ ] **人声测试**：基频和共振峰清晰
- [ ] **峰值检测**：自动标记正确的峰值
- [ ] **鼠标交互**：悬停显示正确的频率和幅度
- [ ] **缩放功能**：滚轮缩放工作正常
- [ ] **坐标轴**：刻度标签正确
- [ ] **声谱图**：时间-频率变化清晰

### 推荐测试音频

**标准测试音频文件：**
1. **440Hz_sine.wav** - 标准 A4 音符
2. **sweep_20-20k.wav** - 频率扫描
3. **white_noise.wav** - 白噪声
4. **piano_scale.wav** - 钢琴音阶
5. **speech_sample.wav** - 人声样本

**在线资源：**
- https://freesound.org/ - 免费音效库
- https://www.audiocheck.net/ - 音频测试工具

---

## 开发历史

### 重构过程

1. **库分离** - 将自定义控件分离为独立的 AudioSpectrumVisualizer 库
2. **参数开放** - 所有配置参数开放为公共属性
3. **坐标轴对齐** - 为声谱图添加坐标轴系统
4. **高度统一** - 使用 SplitContainer 实现动态高度对齐
5. **主题系统** - 添加 ColorTheme 类支持深色/浅色主题
6. **设置持久化** - 实现窗口状态和配置的自动保存
7. **交互增强** - 添加拖动平移功能
8. **文档完善** - 添加完整的中英文文档

### 关键改进

- ✅ 从单体应用重构为可复用库
- ✅ 添加完整的坐标轴系统
- ✅ 实现响应式布局（SplitContainer）
- ✅ 完善峰值检测功能
- ✅ 优化性能（双缓冲、unsafe代码）
- ✅ 添加主题系统（深色/浅色）
- ✅ 实现设置持久化
- ✅ 增强交互功能（拖动平移）
- ✅ 提高采样率和FFT分辨率（应用程序）

### 技术亮点

- **Cooley-Tukey FFT** - 高效的FFT算法实现
- **Hann窗函数** - 减少频谱泄漏
- **双缓冲渲染** - 避免闪烁
- **Unsafe代码** - 直接操作像素提升性能
- **线程安全** - 支持多线程数据更新
- **响应式设计** - 自适应窗口大小

---

## 相关文档

- [AudioSpectrumVisualizer/README.md](AudioSpectrumVisualizer/README.md) - 库的完整API文档
- [CLAUDE.md](CLAUDE.md) - 项目指导文档

---

## 许可证

MIT License - 完全开源，可商用

---

**最后更新：** 2026-01-29
